<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Reset Password</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="css/style.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body class="bg-light">
<div class="container py-5">
  <div class="row justify-content-center">
    <div class="col-md-6">
      <div class="card shadow">
        <div class="card-header bg-warning text-dark text-center"><h4>Password Reset</h4></div>
        <div class="card-body">

          <!-- Step 1: Request OTP -->
          <form id="step1">
            <div class="mb-3"><input type="email" class="form-control" placeholder="Your email" id="email" required></div>
            <button type="submit" class="btn btn-warning w-100">Send OTP</button>
          </form>

          <!-- Step 2: Enter OTP + New Password -->
          <form id="step2" class="d-none mt-4">
            <div class="mb-3"><input type="text" class="form-control" placeholder="OTP (6 digits)" id="otp" maxlength="6" required></div>
            <div class="mb-3"><input type="password" class="form-control" placeholder="New password" id="newPwd" required></div>
            <button type="submit" class="btn btn-success w-100">Reset Password</button>
          </form>

        </div>
      </div>
    </div>
  </div>
</div>

<script>
  const API_URL = 'https://script.google.com/macros/s/AKfycbxikiNIi81cPsekdg_z8yClvwGQbp92z-AMQrNixtw-yK1KN6ZUSyVAc_i-IUoMf4MQ2Q/exec';
  let currentEmail = '';

  async function api(action, data = {}) {
  const payload = { action, ...data };
  console.log('Sending:', payload); // â† DEBUG

  try {
    const resp = await fetch(API_URL, {
      method: 'POST',
      body: JSON.stringify(payload),
      headers: { 'Content-Type': 'text/plain' },
      mode: 'cors'
    });
    const result = await resp.json();
    console.log('Response:', result);
    return result;
  } catch (err) {
    console.error('Fetch error:', err);
    return { error: 'Network error' };
  }
}

  document.getElementById('step1').onsubmit = async e => {
    e.preventDefault();
    currentEmail = document.getElementById('email').value.trim();
    try {
      const res = await api('requestOtp', { email: currentEmail });
      if (res.error) throw res.error;
      Swal.fire('OTP Sent', res.msg, 'info');
      document.getElementById('step1').classList.add('d-none');
      document.getElementById('step2').classList.remove('d-none');
    } catch (err) {
      Swal.fire('Error', err, 'error');
    }
  };

  document.getElementById('step2').onsubmit = async e => {
    e.preventDefault();
    const payload = {
      email: currentEmail,
      otp: document.getElementById('otp').value.trim(),
      newPassword: document.getElementById('newPwd').value
    };
    try {
      const res = await api('verifyOtp', payload);
      if (res.error) throw res.error;
      Swal.fire('Success', res.msg, 'success').then(() => location.href = 'login.html');
    } catch (err) {
      Swal.fire('Error', err, 'error');
    }
  };
</script>
</body>
</html>
