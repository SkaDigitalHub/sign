<!DOCTYPE html>
<html>
<head>
  <title>User Dashboard</title>
  <style>
    body { font-family: sans-serif; display: flex; justify-content: center; padding-top: 50px; }
    .card { border: 1px solid #ddd; padding: 20px; border-radius: 8px; width: 300px; text-align: center; }
    .hidden { display: none; }
  </style>
</head>
<body>

  <div id="loading">Verifying session...</div>

  <div id="mainContent" class="hidden">
    <div class="card">
      <h1>Welcome!</h1>
      <p id="userGreeting"></p>
      <hr>
      <button onclick="handleLogout()">Logout</button>
    </div>
  </div>

  <script>
    const API_URL = 'YOUR_APPS_SCRIPT_URL'; // Replace with your Web App URL

    async function checkSession() {
      const token = localStorage.getItem('session_token');
      
      if (!token) {
        window.location.href = 'login.html';
        return;
      }

      const formData = new FormData();
      formData.append('function', 'validateSession');
      formData.append('data', JSON.stringify({ token: token }));

      try {
        const response = await fetch(API_URL, { method: 'POST', body: formData });
        const result = await response.json();

        if (result.success) {
          document.getElementById('loading').classList.add('hidden');
          document.getElementById('mainContent').classList.remove('hidden');
          document.getElementById('userGreeting').innerText = `Logged in as: ${result.email}`;
        } else {
          handleLogout(); // Token expired or invalid
        }
      } catch (e) {
        alert("Connection error");
      }
    }

    async function handleLogout() {
      const token = localStorage.getItem('session_token');
      const formData = new FormData();
      formData.append('function', 'logout');
      formData.append('data', JSON.stringify({ token: token }));

      await fetch(API_URL, { method: 'POST', body: formData });
      localStorage.removeItem('session_token');
      window.location.href = 'login.html';
    }

    // Run on page load
    checkSession();
  </script>
</body>
</html>
